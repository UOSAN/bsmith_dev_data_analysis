---
title: "read SST behavioral data"
author: "Ben Smith"
date: "9/14/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r}
library(R.matlab)#install.packages("R.matlab")
library(dplyr)
library(stringr)
data_path <- "../../../files/data/"
dropbox_path <- "/Users/benjaminsmith/Dropbox (University of Oregon)/UO-SAN Lab"
sst_on_dropbox <- paste0(dropbox_path, "/Berkman Lab/Devaluation/Tasks/SST_DEV")
```


### Grabbing and summarizing from the raw data


Now create a function to do one run

```{r}
get_run_df <- function(run_mat_file){
  conditions <- unlist(run_mat_file$names)
  run_df <- NULL
  for (c_i in 1:length(conditions)){
    print(paste(length(run_mat_file$duration[[c_i]][[1]]),length(run_mat_file$onsets[[c_i]][[1]])))
    #need to handle cases where the lengths are zero
    if(length(run_mat_file$duration[[c_i]][[1]])!=length(run_mat_file$onsets[[c_i]][[1]])){
      stop("found different length duration and onset. these should be the same.")
    }
    if(length(run_mat_file$duration[[c_i]][[1]])==0){
      #no items for this condition  
      print(paste("no events found for condition",conditions[[c_i]]))
      next
    }

    
    condition_df <- data.frame(onset=run_mat_file$onsets[[c_i]][[1]],duration=run_mat_file$duration[[c_i]][[1]],condition=conditions[[c_i]])
    if (is.null(run_df)){
      run_df <- condition_df
    }else{
      run_df <- rbind(run_df,condition_df)
    }
  }
  
  run_df <- run_df %>% arrange(onset)
  return(run_df)
}
```

```{r}
#now loop through the mat files.
behavioral_data_filepath <- paste0(data_path,"DEV_behavioral_data/")
fname_list <- list.files(behavioral_data_filepath,pattern = "DEV.*\\.mat")
library(stringi)
library(stringr)
#finfo <- str_match(fname_list[[1]],"(DEV\\d{3})_(\\d)_SST(\\d)")
study_df <- NULL
for (fname in fname_list){
  print(fname)
  run_mat_file <- readMat(paste0(behavioral_data_filepath,fname))
  run_df <- get_run_df(run_mat_file)
  finfo <- str_match(fname,"(DEV\\d{3})_(\\d)_SST(\\d)")
  subid <- finfo[,2]
  waveid <- finfo[,3]
  runid <- finfo[,4]
  #need to market the run and subject ID
  run_df$subid <- subid
  run_df$waveid <- waveid
  run_df$runid <- runid
  
  #now rbind
  if (is.null(study_df)){
      study_df <- run_df
    }else{
      study_df <- rbind(study_df,run_df)
    }
}



```


```{r}
readr::write_csv(study_df,file = paste0(data_path,"sst_behavioral_data_all.csv"))
```


```{r}
fname <- "DEV004_3_SST1.mat"
run_mat_file <- readMat(paste0(behavioral_data_filepath,fname))
```

```{r}
#now we get summary statistics for each subject:
#direction errors, proportion of successful stops, reaction time on Go trials, and stop signal reaction time (SSRT).
#add runid to the group_by clause to group by run; but for our purposes we are happy to count across run!

condition_count <- study_df %>% group_by(subid,condition) %>% count() %>% ungroup()
go_trial_mean_reaction_time <- study_df %>% group_by(subid) %>% filter(condition=="CorrectGo" | condition=="FailedGo") %>% summarise(go_trial_reaction_time = mean(duration)) %>% ungroup()

stop_signal_mean_reaction_time <- study_df %>% group_by(subid) %>% filter(condition=="CorrectStop") %>% summarise(raw_stop_signal_duration = mean(duration)) %>% ungroup()

prop_successful_stops <- condition_count %>% group_by(subid) %>% 
  tidyr::spread(key = "condition",value="n") %>%
  mutate(prop_successful_stops=CorrectStop/(CorrectStop+FailedStop)) %>% ungroup()

for(cname in c("CorrectGo","CorrectStop","FailedGo","FailedStop")){
  prop_successful_stops[is.na(prop_successful_stops[[cname]]),cname]<-0
}

summary_stats <- prop_successful_stops %>% merge(stop_signal_mean_reaction_time) %>% merge(go_trial_mean_reaction_time)



```

```{r}
summary_stats
```

```{r}

readr::write_csv(summary_stats,file=paste0(data_path,"sst_summary_stats.csv"))

```

```{r}
#now we get summary statistics for each subject:
#direction errors, proportion of successful stops, reaction time on Go trials, and stop signal reaction time (SSRT).
#add runid to the group_by clause to group by run; but for our purposes we are happy to count across run!

condition_count <- study_df %>% group_by(runid,subid,condition) %>% count() %>% ungroup()
go_trial_mean_reaction_time <- study_df %>% group_by(runid,subid) %>% filter(condition=="CorrectGo" | condition=="FailedGo") %>% summarise(go_trial_reaction_time = mean(duration)) %>% ungroup()

stop_signal_mean_reaction_time <- study_df %>% group_by(runid,subid) %>% filter(condition=="CorrectStop") %>% summarise(reaction_time = mean(duration)) %>% ungroup()

prop_successful_stops <- condition_count %>% group_by(runid,subid) %>% 
  tidyr::spread(key = "condition",value="n") %>%
  mutate(prop_successful_stops=CorrectStop/(CorrectStop+FailedStop)) %>% ungroup()

for(cname in c("CorrectGo","CorrectStop","FailedGo","FailedStop")){
  prop_successful_stops[is.na(prop_successful_stops[[cname]]),cname]<-0
}

summary_stats_by_run <- prop_successful_stops %>% merge(stop_signal_mean_reaction_time) %>% merge(go_trial_mean_reaction_time)


```


```{r}

readr::write_csv(summary_stats_by_run,file=paste0(data_path,"sst_summary_stats_by_run.csv"))

```


## now read the SSRT data

Data presummarized by Krista, Bryan, and Dani.

```{r}


presummarized_sst_filepath <- paste0(sst_on_dropbox,"/compiledResults/upToDEV228/varMats/resultVars16.mat")

presummarized_sst_data <-  readMat(presummarized_sst_filepath)
```





```{r}

all_table_longer <- NULL
for (result_item_name in names(presummarized_sst_data)){
  subj_by_wave_table <- data.frame(presummarized_sst_data[[result_item_name]])
  wave_colnames<- paste0("wave",1:ncol(subj_by_wave_table))
  colnames(subj_by_wave_table)<-wave_colnames
  subj_by_wave_table$SubjectLabel <- paste0("DEV",str_pad(as.character(1:nrow(subj_by_wave_table)),3,pad="0"))
  
  table_longer <- subj_by_wave_table %>% tidyr::pivot_longer(cols=wave_colnames,names_to="wave")
  table_longer$value_type <- result_item_name
  if(is.null(all_table_longer)){
    all_table_longer <- table_longer
  }else{
    all_table_longer <- rbind(all_table_longer,table_longer)
  }
}

all_table_longer$value_type <- sub(".results","",all_table_longer$value_type)

presummarized_data_all_raw <- all_table_longer %>% tidyr::pivot_wider(id_cols=c("SubjectLabel","wave"),values_from="value",names_from="value_type")

row_na_count<-apply(presummarized_data_all_raw,1,function(r){sum(is.na(r))})
row_without_values <- max(row_na_count)==row_na_count

presummarized_data_all <- presummarized_data_all_raw[row_without_values==FALSE,]

presummarized_data_all$wave <-as.integer(sub("wave","",presummarized_data_all$wave))
```



```{r}

readr::write_csv(presummarized_data_all,file=paste0(data_path,"sst_pre_analyzed_stats.csv"))

```





